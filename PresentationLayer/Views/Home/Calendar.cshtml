@model PresentationLayer.Models.CalendarViewModel

@{
    ViewData["Title"] = "Calendar";
    var month = Model.CurrentMonth;
    var daysInMonth = DateTime.DaysInMonth(month.Year, month.Month);

    var firstDay = new DateTime(month.Year, month.Month, 1);
    var firstWeekday = (int)firstDay.DayOfWeek; 
}

<h2 class="mb-4">Calendar</h2>

<div class="d-flex justify-content-between mb-3">
    <a class="btn btn-light"
       asp-action="Calendar"
       asp-route-date="@month.AddMonths(-1)">
        ← @month.AddMonths(-1).ToString("MMMM yyyy")
    </a>

    <h3>@month.ToString("MMMM yyyy")</h3>

    <a class="btn btn-light"
       asp-action="Calendar"
       asp-route-date="@month.AddMonths(1)">
        @month.AddMonths(1).ToString("MMMM yyyy") →
    </a>
</div>

<table class="table text-center calendar-table">
    <thead>
        <tr>
            <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th>
            <th>Thu</th><th>Fri</th><th>Sat</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            @for (int i = 0; i < firstWeekday; i++)
            {
                <td></td>
            }

            @for (int day = 1; day <= daysInMonth; day++)
            {
                var currentDate = new DateTime(month.Year, month.Month, day);
                bool isSelected = Model.SelectedDate.HasValue &&
                                  Model.SelectedDate.Value.Date == currentDate.Date;

                <td class="calendar-day @(isSelected ? "selected-day" : "")">
                    <a asp-action="Calendar"
                       asp-route-date="@currentDate"
                       style="text-decoration:none;color:inherit;">
                        @day
                    </a>
                </td>

                if ((day + firstWeekday) % 7 == 0)
                {
                    @:</tr><tr>
                }
            }
        </tr>
    </tbody>
</table>

<hr />

@if (Model.SelectedDate.HasValue)
{
    <h4>Tasks for @Model.SelectedDate.Value.ToString("MMMM dd, yyyy")</h4>
}
else
{
    <h4>All tasks this month</h4>
}

@if (!Model.Tasks.Any())
{
    <p class="text-muted">No tasks for this date.</p>
}
else
{
    <div class="mt-3">
        @foreach (var task in Model.Tasks.OrderBy(t => t.DueDate))
        {
            var bg = task.IsCompleted ? "background:#34d399;" : "background:#60a5fa;";
            var color = "color:white;";

            <div class="p-3 mb-3 rounded shadow-sm" style="@bg @color">
                <div class="d-flex justify-content-between">
                    <strong>@task.Title</strong>

                    @if (!task.IsCompleted)
                    {
                        <form asp-action="CompleteTask" asp-route-id="@task.Id" method="post">
                            <button class="btn btn-light btn-sm">✔ Done</button>
                        </form>
                    }
                </div>

                @if (!string.IsNullOrWhiteSpace(task.Description))
                {
                    <p class="mt-2">@task.Description</p>
                }

                <small>@task.DueDate?.ToString("MMM dd")</small>
            </div>
        }
    </div>
}

<style>
.calendar-table td {
    width: 40px;
    height: 40px;
    cursor: pointer;
    vertical-align: middle;
}

.calendar-day:hover {
    background: #e0e7ff;
    border-radius: 6px;
    transition: 0.2s;
}

.selected-day {
    background: #3b82f6 !important;
    color: white;
    border-radius: 6px;
}
</style>
