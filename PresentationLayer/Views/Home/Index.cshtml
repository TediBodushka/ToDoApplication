@model DashboardViewModel
@using BusinessLayer
@using System.Linq

@{
    ViewData["Title"] = "Tasks";
    var today = DateTime.Today;

    var categoryCounts = Model.Categories
        .Cast<Category>()
        .ToDictionary(
            c => c.Id,
            c => Model.Tasks.Cast<TaskItem>().Count(t => t.CategoryId == c.Id && !t.IsCompleted)
        );

    int completedCount = Model.Tasks.Cast<TaskItem>().Count(t => t.IsCompleted);

    int notCompletedCount = Model.Tasks.Cast<TaskItem>()
        .Count(t => !t.IsCompleted && t.DueDate.HasValue && t.DueDate.Value.Date < today);
}

@functions {
    string ColorForCategory(string title)
    {
        return title.ToLower() switch
        {
            "work" => "card-blue",
            "personal" => "card-purple",
            "shopping" => "card-orange",
            "health" => "card-pink",
            "beauty" => "card-pink",
            "school" => "card-green",
            _ => "card-blue"
        };
    }
}

<div class="dashboard-container container-fluid pt-4">

    <div class="mb-3">
        <h3>
            @(
                        Model.Tasks.Cast<TaskItem>().Count(t => t.DueDate?.Date == today && !t.IsCompleted) == 0
                        ? "Hello, you have completed all tasks for today!"
                        : $"Hello, you have {Model.Tasks.Cast<TaskItem>().Count(t => t.DueDate?.Date == today && !t.IsCompleted)} tasks today!")
        </h3>
    </div>

    <div class="mb-2"><h5>Categories</h5></div>

    <div class="category-row mb-4">
        @foreach (var cat in Model.Categories.Cast<Category>())
        {
            var colorClass = ColorForCategory(cat.Title);
            var count = categoryCounts[cat.Id];

            <div class="category-card @colorClass" style="position:relative;">
                <a asp-controller="Category" asp-action="Edit" asp-route-id="@cat.Id"
                   style="position:absolute; right:35px; top:6px; font-size:18px;">✏️</a>

                <a asp-controller="Category" asp-action="Delete" asp-route-id="@cat.Id"
                   onclick="return confirm('Delete this category and ALL tasks in it?');"
                   style="position:absolute; right:8px; top:6px; font-size:18px;">🗑️</a>

                <a asp-action="Index" asp-route-categoryId="@cat.Id"
                   style="text-decoration:none; color:inherit;">
                    <div class="category-title">@cat.Title</div>
                    <div class="category-count">@count tasks</div>
                </a>
            </div>
        }

        <div class="category-card card-green" onclick="toggleCompleted()" style="cursor:pointer;">
            <div class="category-title">Completed</div>
            <div class="category-count">@completedCount</div>
        </div>

        <div class="category-card card-red" onclick="toggleOverdue()" style="cursor:pointer;">
            <div class="category-title">Not Completed</div>
            <div class="category-count">@notCompletedCount</div>
        </div>
    </div>

    <!-- Completed -->
    <div id="completedList" style="display:none; margin-bottom:20px;">
        @foreach (var task in Model.CompletedTasks.Cast<TaskItem>())
        {
            <div class="task-card"
                 style="background:#4CAF50; color:white; border-radius:10px; padding:14px; margin-bottom:14px;">
                <strong>@task.Title</strong>
                <div>@task.DueDate?.ToString("MMM d, yyyy")</div>
            </div>
        }
    </div>

    <!-- Not Completed (Overdue Only) -->
    <div id="overdueList" style="display:none; margin-bottom:20px;">
        @foreach (var task in Model.Tasks.Cast<TaskItem>().Where(t => !t.IsCompleted && t.DueDate < today))
        {
            <div class="task-card"
                 style="background:#E53935; color:white; border-radius:10px; padding:14px; margin-bottom:14px;">
                <strong>@task.Title</strong>
                <div>@task.DueDate?.ToString("MMM d, yyyy")</div>
            </div>
        }
    </div>

    <div class="mb-3 mt-4"><h5>My tasks</h5></div>

    @{
        var tasks = Model.SelectedCategoryId.HasValue
        ? Model.Tasks.Cast<TaskItem>().Where(t =>
        t.CategoryId == Model.SelectedCategoryId.Value &&
        !t.IsCompleted &&
        (t.DueDate == null || t.DueDate >= today)
        ).ToList()
        : Model.Tasks.Cast<TaskItem>().Where(t =>
        !t.IsCompleted &&
        (t.DueDate == null || t.DueDate >= today)
        ).ToList();

        tasks = tasks.OrderBy(t => t.DueDate ?? DateTime.MaxValue).ToList();
    }

    @foreach (var t in tasks)
    {
        string bg;

        if (t.IsCompleted) bg = "#4CAF50";
        else bg = Model.Categories.Cast<Category>().First(c => c.Id == t.CategoryId).Color;

        <div class="task-card"
             style="background:@bg; color:white; border-radius:10px; padding:14px; margin-bottom:14px; position:relative;">

            @if (!t.IsCompleted)
            {
                <a asp-action="CompleteTask" asp-route-id="@t.Id"
                   style="position:absolute; left:18px; top:50%; transform:translateY(-50%);">
                    <div class="task-check-circle"></div>
                </a>
            }

            <div style="margin-left:55px;">
                <a href="@Url.Action("TaskDetails", "Home", new { id = t.Id })"
                   style="text-decoration:none; color:white; font-size:18px; font-weight:600;">
                    @t.Title
                </a>
                <div style="font-size:14px; opacity:0.9;">@t.DueDate?.ToString("MMM d, yyyy")</div>
            </div>
        </div>
    }
</div>

<button class="fab-btn" onclick="toggleFabMenu()">+</button>

<div id="fabMenu" style="
    display:none;
    position:fixed;
    bottom:100px;
    right:30px;
    background:white;
    border-radius:14px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    padding:12px;
    z-index:9999;">

    <button onclick="location.href='@Url.Action("CreateTask", "Home")'"
            style="width:140px; padding:8px; border:none; background:#4287f5; color:white; border-radius:8px; margin-bottom:8px;">
        Add Task
    </button>

    <button onclick="location.href='@Url.Action("CreateCategory", "Home")'"
            style="width:140px; padding:8px; border:none; background:#34c759; color:white; border-radius:8px;">
        Add Category
    </button>
</div>

<footer class="bottom-nav">
    <a asp-action="Index" asp-controller="Home" class="nav-item nav-active"><span>Tasks</span></a>
    <a asp-action="Calendar" asp-controller="Home" class="nav-item"><span>Calendar</span></a>
    <a asp-action="Profile" asp-controller="Home" class="nav-item"><span>Me</span></a>
</footer>

<script>
    function toggleCompleted() {
        const el = document.getElementById("completedList");
        el.style.display = el.style.display === "none" ? "block" : "none";
    }

    function toggleOverdue() {
        const el = document.getElementById("overdueList");
        el.style.display = el.style.display === "none" ? "block" : "none";
    }

    function toggleFabMenu() {
        const menu = document.getElementById("fabMenu");
        menu.style.display = (menu.style.display === "block") ? "none" : "block";
    }

    document.addEventListener("click", function (e) {
        const menu = document.getElementById("fabMenu");
        const fab = document.querySelector(".fab-btn");
        if (!menu.contains(e.target) && !fab.contains(e.target)) {
            menu.style.display = "none";
        }
    });
</script>
