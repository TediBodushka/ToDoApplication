@model PresentationLayer.Models.DashboardViewModel
@using BusinessLayer

@{
    ViewData["Title"] = "Tasks";
    var today = DateTime.Today;

    var categoryCounts = Model.Categories.ToDictionary(
        c => c.Id,
        c => Model.Tasks.Count(t => t.CategoryId == c.Id && !t.IsCompleted)
    );

    int completedCount = Model.Tasks.Count(t => t.IsCompleted);
    int notCompletedCount = Model.Tasks.Count(t =>
        !t.IsCompleted && t.DueDate.HasValue && t.DueDate.Value.Date < today);
}

@functions {
    string ColorForCategory(string title)
    {
        return title.ToLower() switch
        {
            "work" => "card-blue",
            "personal" => "card-purple",
            "shopping" => "card-orange",
            "health" => "card-pink",
            "beauty" => "card-pink",
            "school" => "card-green",
            _ => "card-blue"
        };
    }
}

<div class="dashboard-container container-fluid pt-4">

    <div class="mb-3">
        <h3>
            @(Model.Tasks.Count(t => t.DueDate?.Date == today && !t.IsCompleted) == 0
                ? "Hello, you have completed all tasks for today!"
                : $"Hello, you have {Model.Tasks.Count(t => t.DueDate?.Date == today && !t.IsCompleted)} tasks today!")
        </h3>
    </div>

    <div class="mb-2">
        <h5>Categories</h5>
    </div>

    <div class="category-row mb-4">
        @foreach (var cat in Model.Categories)
        {
            var colorClass = ColorForCategory(cat.Title);
            var count = categoryCounts[cat.Id];

            <div class="category-card @colorClass" style="position:relative;">
                <a asp-controller="Category" asp-action="Edit" asp-route-id="@cat.Id"
                   style="position:absolute; right:35px; top:6px; font-size:18px;">✏️</a>

                <a asp-controller="Category" asp-action="Delete" asp-route-id="@cat.Id"
                   onclick="return confirm('Delete this category and ALL tasks in it?');"
                   style="position:absolute; right:8px; top:6px; font-size:18px;">🗑️</a>

                <a asp-action="Index" asp-route-categoryId="@cat.Id"
                   style="text-decoration:none; color:inherit;">
                    <div class="category-title">@cat.Title</div>
                    <div class="category-count">@count tasks</div>
                </a>
            </div>
        }

        <div class="category-card card-green" onclick="toggleCompleted()" style="cursor:pointer;">
            <div class="category-title">Completed</div>
            <div class="category-count">@completedCount</div>
        </div>

        <div class="category-card card-red">
            <div class="category-title">Not Completed</div>
            <div class="category-count">@notCompletedCount</div>
        </div>
    </div>

    <!-- Completed Collapse -->
    <div id="completedList" style="display:none; margin-bottom:20px;">
        @foreach (var task in Model.CompletedTasks)
        {
            <div class="task-card"
                 style="background:#4CAF50; color:white; border-radius:10px; padding:14px; margin-bottom:14px; display:flex; align-items:center; gap:14px;">
                
                <!-- ❌ Махнато кръгче при Completed -->

                <div>
                    <strong>@task.Title</strong>
                    <div>@task.DueDate?.ToString("MMM d, yyyy")</div>
                </div>
            </div>
        }
    </div>

    <div class="mb-3 mt-4">
        <h5>My tasks</h5>
    </div>

    @{
        var tasks = Model.SelectedCategoryId.HasValue
        ? Model.Tasks.Where(t => t.CategoryId == Model.SelectedCategoryId.Value && !t.IsCompleted).ToList()
        : Model.Tasks.Where(t => !t.IsCompleted).ToList();

        tasks = tasks.OrderBy(t => t.DueDate ?? DateTime.MaxValue).ToList();
    }

    @if (!tasks.Any())
    {
        <div class="center-empty">
            <p>No tasks yet.</p>
            <p>Click + to add your first task.</p>
        </div>
    }
    else
    {
        @foreach (var t in tasks)
        {
            string bg;

            if (t.IsCompleted) bg = "#4CAF50";
            else if (t.DueDate < today) bg = "#E53935";
            else bg = Model.Categories.First(c => c.Id == t.CategoryId).Color;

            <div class="task-card"
                 style="background:@bg; color:white; border-radius:10px; padding:14px; margin-bottom:14px; position:relative;">

                <!-- ✔ Кръгчето само ако НЕ е completed -->
                @if (!t.IsCompleted)
                {
                    <a asp-action="CompleteTask" asp-route-id="@t.Id"
                       style="position:absolute; left:18px; top:50%; transform:translateY(-50%); text-decoration:none;">
                        <div class="task-check-circle"></div>
                    </a>
                }

                <div style="margin-left:55px; display:flex; justify-content:space-between; align-items:center;">
                    <a href="@Url.Action("TaskDetails", new { id = t.Id })"
                       style="text-decoration:none; color:white; font-size:18px; font-weight:600;">
                        @t.Title
                    </a>

                    <div style="display:flex; gap:10px; font-size:21px;">
                        <a asp-action="EditTask" asp-route-id="@t.Id"
                           onclick="event.stopPropagation();"
                           style="text-decoration:none; color:white;">✏️</a>

                        <a asp-action="DeleteTask" asp-route-id="@t.Id"
                           onclick="event.stopPropagation(); return confirm('Delete this task?');"
                           style="text-decoration:none; color:white;">🗑️</a>
                    </div>
                </div>

                <div style="margin-left:55px; font-size:14px; opacity:0.9;">
                    @t.DueDate?.ToString("MMM d, yyyy")
                </div>
            </div>
        }
    }
</div>

<!-- FAB MENU -->
<div id="fabMenu" class="fab-menu">
    <button onclick="location.href='@Url.Action("CreateTask")'">Create a task</button>
    <button onclick="location.href='@Url.Action("CreateCategory")'">Create a category</button>
</div>

<button class="fab-btn" onclick="toggleFabMenu()">+</button>

<script>
function toggleFabMenu() {
    document.getElementById("fabMenu").classList.toggle("show");
}
document.addEventListener("click", function (e) {
    const menu = document.getElementById("fabMenu");
    const fab = document.querySelector(".fab-btn");

    if (!menu.contains(e.target) && !fab.contains(e.target)) {
        menu.classList.remove("show");
    }
});

function toggleCompleted() {
    const list = document.getElementById("completedList");
    list.style.display = list.style.display === "none" ? "block" : "none";
}
</script>
